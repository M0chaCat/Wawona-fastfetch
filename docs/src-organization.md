# Wawona Source Code Organization

## Overview

Wawona is a Wayland compositor supporting **iOS**, **macOS**, and **Android**. The codebase uses:
- Platform conditionals (`#ifdef`) for platform-specific code
- Shared source files compiled for all platforms
- Nix-managed build system defining which files compile per platform

---

## Directory Structure

```
src/
├── core/                    # Core compositor logic (SHARED - all platforms)
├── compositor_implementations/  # Wayland protocol implementations (SHARED)
├── protocols/               # Auto-generated Wayland protocol bindings (SHARED)
├── rendering/               # Rendering backends (PLATFORM-CONDITIONAL)
├── input/                   # Input handling (SHARED)
├── ui/                      # UI components (APPLE ONLY - iOS/macOS)
├── logging/                 # Logging utilities (SHARED)
├── stubs/                   # EGL/Vulkan stubs (PLATFORM-SPECIFIC)
├── compat/                  # Platform compatibility shims
│   ├── ios/                 # iOS-specific headers/functions
│   ├── macos/               # macOS compatibility stubs
│   └── vulkan-stub/         # Vulkan stub for non-Vulkan builds
├── launcher/                # App launcher (APPLE ONLY)
├── extensions/              # iOS App Extensions
├── android/                 # Android JNI and build (ANDROID ONLY)
├── bin/                     # Test utilities
└── resources/               # App resources, icons, plists
```

---

## Understanding `protocols/` vs `compositor_implementations/`

### `src/protocols/` - Auto-Generated Bindings

These files are **auto-generated by `wayland-scanner`** from `.xml` protocol definitions:

| File Type | Purpose |
|-----------|---------|
| `*.xml` | Wayland protocol XML definitions (source of truth) |
| `*-protocol.h` | Generated C header with interface definitions |
| `*-protocol.c` | Generated C code with message serialization |

**Example:** `xdg-shell.xml` → `xdg-shell-protocol.h` + `xdg-shell-protocol.c`

These files define **what** the protocol messages are, not **how** to handle them.

### `src/compositor_implementations/` - Actual Implementations

These files contain the **actual logic** for handling protocol requests:

| File | Status | Description |
|------|--------|-------------|
| `xdg_shell.c` | ✅ **Real** | XDG shell window management |
| `wayland_shm.c` | ✅ **Real** | Shared memory buffers (uses libwayland built-in) |
| `wayland_output.c` | ✅ **Real** | Output/display management |
| `wayland_fullscreen_shell.c` | ✅ **Real** | Fullscreen shell support |
| `wayland_linux_dmabuf.c` | ✅ **Real** | DMA-BUF buffer sharing |
| `wayland_decoration.c` | ✅ **Real** | Server-side decorations |
| `wayland_viewporter.c` | ✅ **Real** | Surface scaling/cropping |
| `wayland_subcompositor.c` | ✅ **Real** | Subsurface management |
| `wayland_data_device_manager.c` | ✅ **Real** | Clipboard/drag-drop |
| `wayland_seat.c` (in input/) | ✅ **Real** | Input device management |
| `wayland_color_management.c` | ✅ **Real** | HDR color management |
| `wayland_screencopy.c` | ✅ **Real** | Screen capture protocol |
| `wayland_presentation.c` | ✅ **Real** | Presentation timing |
| `wayland_idle_inhibit.c` | ✅ **Real** | Idle inhibition |
| `wayland_pointer_gestures.c` | ✅ **Real** | Touchpad gestures |
| `wayland_relative_pointer.c` | ✅ **Real** | Relative pointer motion |
| `wayland_pointer_constraints.c` | ✅ **Real** | Pointer lock/confine |
| `wayland_tablet.c` | ✅ **Real** | Tablet/stylus support |
| `wayland_keyboard_shortcuts.c` | ✅ **Real** | Keyboard shortcuts inhibit |
| `wayland_gtk_shell.c` | ⚠️ **Stub** | GTK shell (not implemented) |
| `wayland_plasma_shell.c` | ⚠️ **Stub** | KDE Plasma shell (not implemented) |
| `wayland_qt_extensions.c` | ⚠️ **Stub** | Qt extensions (not implemented) |
| `wayland_drm.c` | ⚠️ **Stub** | Legacy DRM (not implemented) |
| `wayland_shell.c` | ⚠️ **Partial** | Legacy wl_shell |
| `wayland_primary_selection.c` | ⚠️ **Partial** | Primary selection |
| `wayland_idle_manager.c` | ⚠️ **Partial** | Idle notification |
| `wayland_protocol_stubs.c` | ⚠️ **Stub** | Placeholder for unimplemented protocols |

---

## Platform Conditionals Reference

### Common Macros

```c
// Apple platforms (iOS + macOS)
#ifdef __APPLE__

// iOS specifically
#if TARGET_OS_IPHONE || TARGET_OS_SIMULATOR

// macOS specifically  
#if !TARGET_OS_IPHONE && !TARGET_OS_SIMULATOR

// Android
#ifdef __ANDROID__

// Vulkan enabled
#if HAVE_VULKAN
```

### Per-File Platform Usage

| Directory | Files | Platforms |
|-----------|-------|-----------|
| `core/` | All `.m` files | iOS, macOS (Objective-C) |
| `core/` | `.c` files | All (via conditionals) |
| `rendering/` | `metal_*.m` | iOS, macOS |
| `rendering/` | `vulkan_renderer.m` | iOS, macOS (optional) |
| `rendering/` | `android_dmabuf.c` | Android only |
| `ui/` | All files | iOS, macOS |
| `input/` | `input_handler.m` | iOS, macOS (has conditionals) |
| `android/` | All files | Android only |
| `compat/ios/` | All files | iOS only |
| `compat/macos/` | All files | macOS only |

---

## Build System Source Lists

Defined in `dependencies/wawona.nix`:

### `commonSources` (Shared across all Apple platforms)
- Core compositor logic
- Protocol implementations  
- Protocol bindings
- Rendering (Metal)
- Input handling
- UI components

### `iosSources` = `commonSources` + iOS-specific:
- `WawonaKernelTests.m/h`
- `WawonaLauncherClient.m/h`
- `color-management-v1-protocol.c`

### `macosSources` = `commonSources` minus:
- `vulkan_renderer.m/h` (excluded currently)
- `WawonaSettings.c` (uses `.m` version)

### `androidSources` = filtered `commonSources`:
- Only `.c` files (no Objective-C)
- Excludes Apple-specific files
- Plus: `android_jni.c`, `android_dmabuf.c`, `egl_buffer_handler.c`

---

## Cleanup Recommendations

### 1. Remove Pure Stubs
These files only contain empty functions and can be deleted:

```bash
# Candidates for deletion (verify they're not referenced)
src/compositor_implementations/wayland_gtk_shell.c    # Stub only
src/compositor_implementations/wayland_gtk_shell.h
src/compositor_implementations/wayland_plasma_shell.c # Stub only  
src/compositor_implementations/wayland_plasma_shell.h
src/compositor_implementations/wayland_qt_extensions.c # Stub only
src/compositor_implementations/wayland_qt_extensions.h
src/compositor_implementations/wayland_drm.c          # Stub only (we use dmabuf)
src/compositor_implementations/wayland_drm.h
```

### 2. Consolidate Protocol Stubs
`wayland_protocol_stubs.c` contains many `return NULL` stubs. Consider:
- Remove stubs for protocols we'll never implement (GTK, Plasma, Qt)
- Keep stubs for protocols we plan to implement later

### 3. Add Platform Markers to Headers
Add clear documentation at the top of files:

```c
// wayland_output.c
// Platform: ALL (iOS, macOS, Android)
// Description: Wayland output/display management
```

### 4. Reorganize by Platform
Consider moving platform-specific code:

```
src/
├── shared/              # Cross-platform code
│   ├── compositor/      # Protocol implementations
│   ├── protocols/       # Generated bindings
│   └── input/           # Input handling
├── apple/               # iOS + macOS shared
│   ├── rendering/       # Metal rendering
│   └── ui/              # Objective-C UI
├── ios/                 # iOS only
│   ├── compat/          # iOS compatibility
│   └── extensions/      # App extensions
├── macos/               # macOS only
│   └── compat/          # macOS stubs
└── android/             # Android only
    ├── jni/             # JNI bridge
    └── rendering/       # EGL/Android rendering
```

### 5. Document Stub Protocols

Create a tracking file for protocol implementation status:

```markdown
# Protocol Implementation Status

## Fully Implemented
- [x] xdg-shell (xdg_shell.c)
- [x] wl_shm (wayland_shm.c)
- [x] wl_output (wayland_output.c)
...

## Partially Implemented
- [ ] zwp_primary_selection (basic structure only)
...

## Not Planned
- [ ] gtk_shell1 (GTK-specific, not needed)
- [ ] org_kde_plasma_shell (KDE-specific, not needed)
```

---

## Quick Reference: What To Look At

| You want to... | Look at... |
|----------------|------------|
| Understand window management | `compositor_implementations/xdg_shell.c` |
| Add new protocol support | Create in `compositor_implementations/`, bind in `WawonaCompositor.m` |
| Modify iOS-specific code | Files with `TARGET_OS_IPHONE` |
| Modify macOS-specific code | Files with `!TARGET_OS_IPHONE && !TARGET_OS_SIMULATOR` |
| Modify Android code | `src/android/` + files with `__ANDROID__` |
| Add rendering features | `src/rendering/` (Metal on Apple, EGL on Android) |
| Change input handling | `src/input/input_handler.m` + `wayland_seat.c` |

---

## Summary

- **`protocols/`** = Auto-generated from XML (don't edit `.c`/`.h` files manually)
- **`compositor_implementations/`** = Your actual protocol handlers
- Most stubs exist for protocol completeness, not functionality
- Platform selection is done via C preprocessor + Nix build lists

